<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <title>Admin Panel - CYA</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="manifest" href="/manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="//api.example.com">
    <link rel="stylesheet" href="css/style.css">
    <script defer>
      if ('serviceWorker' in navigator && location.protocol === 'https:') {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js').catch(err => console.log('SW registration failed:', err));
        });
      } else if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js').catch(err => console.log('SW registration failed:', err));
      }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .admin-wrapper {
            max-width: 1200px;
            margin: 80px auto 20px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.98) 100%);
            padding: 35px;
            border-radius: 18px;
            margin-bottom: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 1px rgba(255,255,255,0.5) inset;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.8);
        }
        
        .admin-header h1 {
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            font-weight: 700;
        }
        
        .admin-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .role-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .admin-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .admin-tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .admin-tab:hover:not(:disabled) {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
            color: white;
            transform: translateY(-2px);
        }
        
        .admin-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .admin-tab:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .admin-section {
            display: none;
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.98) 100%);
            padding: 35px;
            border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 1px rgba(255,255,255,0.5) inset;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.8);
            animation: fadeInUp 0.4s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .admin-section.active {
            display: block;
        }
        
        .admin-section h2 {
            margin: 0 0 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 26px;
            font-weight: 700;
            border-bottom: 3px solid rgba(102, 126, 234, 0.2);
            padding-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #1e293b;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #f8fafc 0%, #f0f4f8 100%);
            font-family: inherit;
        }
        
        .form-group input:hover,
        .form-group select:hover {
            border-color: #cbd5e1;
            background: linear-gradient(135deg, #ffffff 0%, #f5f9fc 100%);
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f5f9fc 100%);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .btn-admin {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-admin.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-admin.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
        
        .btn-admin.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }
        
        .btn-admin.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }
        
        .btn-admin:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4) !important;
        }
        
        .btn-admin:active {
            transform: translateY(-1px);
        }
        
        .btn-admin:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 16px 18px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f4f8 100%);
            font-weight: 700;
            color: #1e293b;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            border-bottom: 3px solid #cbd5e1;
        }
        
        .data-table td {
            font-size: 14px;
            color: #475569;
        }
        
        .data-table tbody tr {
            transition: all 0.3s ease;
        }
        
        .data-table tbody tr:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            box-shadow: inset 0 0 15px rgba(102, 126, 234, 0.1);
        }
        
        .code-badge {
            font-family: 'Monaco', 'Menlo', monospace;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #1e293b;
            border: 1px solid #cbd5e1;
        }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .status-badge.available {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.2);
        }
        
        .status-badge.used {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #7f1d1d;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.2);
        }
        
        .message-box {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
            font-weight: 600;
            animation: slideInDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-left: 5px solid;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }
        
        .message-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            pointer-events: none;
        }
        
        .message-box .msg-icon {
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
        }
        
        .message-box .msg-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .message-box .msg-title {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        .message-box .msg-text {
            font-weight: 500;
            font-size: 13px;
        }
        
        .message-box .msg-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .message-box .msg-close:hover {
            opacity: 1;
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideOutUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        .message-box.success {
            display: flex;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border-left-color: #10b981;
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.25), inset 0 1px 0 rgba(255,255,255,0.4);
        }
        
        .message-box.error {
            display: flex;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #7f1d1d;
            border-left-color: #ef4444;
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.25), inset 0 1px 0 rgba(255,255,255,0.4);
        }
        
        .message-box.warning {
            display: flex;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #78350f;
            border-left-color: #f59e0b;
            box-shadow: 0 15px 35px rgba(245, 158, 11, 0.25), inset 0 1px 0 rgba(255,255,255,0.4);
        }
        
        .message-box.info {
            display: flex;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border-left-color: #3b82f6;
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.25), inset 0 1px 0 rgba(255,255,255,0.4);
        }
        
        .message-box.hide {
            animation: slideOutUp 0.3s ease-in forwards;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border-left: 5px solid;
            border-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%) 1;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.25);
        }
        
        .stat-card h3 {
            margin: 0 0 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            font-weight: 700;
        }
        
        .stat-card p {
            margin: 5px 0 0;
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn-admin {
            padding: 8px 14px;
            font-size: 11px;
        }
        
        .loading {
            text-align: center;
            padding: 60px 40px;
            color: #64748b;
            font-size: 16px;
            font-weight: 600;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 40px;
            height: 40px;
            margin-left: 15px;
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-access {
            text-align: center;
            padding: 80px 40px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(229, 62, 62, 0.05) 100%);
            border-radius: 15px;
            border: 2px solid rgba(239, 68, 68, 0.1);
        }
        
        .no-access h2 {
            color: #dc2626;
            margin: 0 0 15px;
            font-size: 24px;
            font-weight: 700;
        }
        
        .no-access p {
            color: #64748b;
            font-size: 15px;
            margin: 0;
        }
        
        /* Tablet Devices (768px and below) */
        @media (max-width: 1024px) {
            .admin-wrapper {
                max-width: 100%;
                margin: 70px auto 20px;
                padding: 0 15px;
            }
            
            .admin-section {
                padding: 25px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-tabs {
                gap: 8px;
                padding: 10px;
            }
            
            .admin-tab {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
        
        /* Mobile Devices (768px and below) */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .admin-wrapper {
                margin: 60px 0 20px;
            }
            
            .admin-header {
                flex-direction: column;
                text-align: center;
                padding: 25px;
                gap: 20px;
            }
            
            .admin-header h1 {
                font-size: 24px;
            }
            
            .admin-user-info {
                flex-direction: column;
                width: 100%;
                justify-content: center;
            }
            
            .admin-tabs {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
                justify-content: center;
            }
            
            .admin-tab {
                width: 100%;
                padding: 12px 16px;
                font-size: 13px;
                border-radius: 8px;
            }
            
            .admin-section {
                padding: 20px;
                border-radius: 15px;
            }
            
            .admin-section h2 {
                font-size: 20px;
                margin-bottom: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .form-group input,
            .form-group select {
                padding: 11px 14px;
                font-size: 14px;
                border-radius: 8px;
            }
            
            .btn-admin {
                width: 100%;
                padding: 11px 16px;
                font-size: 12px;
            }
            
            .data-table {
                font-size: 12px;
                margin-top: 15px;
                border-radius: 8px;
                overflow: hidden;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px 10px;
                font-size: 11px;
            }
            
            .data-table th {
                font-size: 10px;
                font-weight: 700;
            }
            
            .code-badge {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .status-badge {
                padding: 4px 10px;
                font-size: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .action-buttons .btn-admin {
                padding: 9px 12px;
                font-size: 10px;
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 15px;
            }
            
            .stat-card {
                padding: 18px;
                border-radius: 12px;
            }
            
            .stat-card h3 {
                font-size: 24px;
                margin: 0 0 8px;
            }
            
            .stat-card p {
                font-size: 12px;
            }
            
            .message-box {
                padding: 12px 15px;
                margin: 15px 0;
                border-radius: 10px;
                font-size: 13px;
            }
            
            .loading {
                padding: 40px 20px;
                font-size: 14px;
            }
            
            .loading::after {
                width: 32px;
                height: 32px;
            }
            
            .no-access {
                padding: 50px 20px;
                border-radius: 12px;
            }
            
            .no-access h2 {
                font-size: 20px;
                margin: 0 0 12px;
            }
            
            .no-access p {
                font-size: 14px;
            }
        }
        
        /* Small Phones (480px and below) */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .admin-wrapper {
                margin: 50px 0 15px;
            }
            
            .admin-header {
                padding: 20px;
                gap: 15px;
            }
            
            .admin-header h1 {
                font-size: 20px;
            }
            
            .role-badge {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .admin-tabs {
                flex-direction: column;
                gap: 8px;
                padding: 8px;
            }
            
            .admin-tab {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .admin-section {
                padding: 15px;
                border-radius: 12px;
            }
            
            .admin-section h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 12px;
            }
            
            .form-group input,
            .form-group select {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .btn-admin {
                padding: 10px 14px;
                font-size: 11px;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 8px;
                font-size: 10px;
            }
            
            .data-table {
                display: block;
                width: 100%;
                overflow-x: auto;
            }
            
            .stats-grid {
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-card h3 {
                font-size: 20px;
            }
            
            .action-buttons {
                gap: 6px;
            }
            
            .action-buttons .btn-admin {
                padding: 8px 10px;
                font-size: 9px;
            }
            
            .message-box {
                padding: 10px 12px;
                margin: 12px 0;
                font-size: 12px;
            }
        }
        
        /* Extra Small Phones (320px) */
        @media (max-width: 360px) {
            .admin-header h1 {
                font-size: 18px;
            }
            
            .admin-section h2 {
                font-size: 16px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
                font-size: 9px;
            }
            
            .btn-admin {
                padding: 9px 12px;
                font-size: 10px;
            }
            
            .stat-card h3 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar" id="topNav">
        <div class="nav-brand">
            <span class="cross-icon">‚úù</span>
            <span class="brand-text">CYA Admin</span>
        </div>
        <div class="nav-links" id="navMiddle">
            <a href="dashboard.html">Dashboard</a>
            <a href="game.html">Bible Trivia</a>
            <a href="leaderboard.html">Leaderboard</a>
            <span id="userDisplay"></span>
            <button class="btn btn-danger btn-small" onclick="logout()">Logout</button>
        </div>
        <div class="mobile-menu" id="mobileMenuBtn" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <div class="mobile-nav" id="mobileNav">
        <a href="dashboard.html" onclick="toggleMobileMenu()">Dashboard</a>
        <a href="game.html" onclick="toggleMobileMenu()">Bible Trivia</a>
        <a href="leaderboard.html" onclick="toggleMobileMenu()">Leaderboard</a>
        <span id="userDisplayMobile"></span>
        <button class="btn btn-danger btn-small btn-mobile-logout" onclick="logout()">Logout</button>
    </div>

    <div class="admin-wrapper">
        <div id="loadingState" class="loading">
            <p>Checking permissions...</p>
        </div>
        
        <div id="noAccessState" class="no-access" style="display: none;">
            <h2>Access Denied</h2>
            <p>You don't have permission to access the admin panel.</p>
            <a href="dashboard.html" class="btn-admin primary" style="margin-top: 20px; display: inline-block; text-decoration: none;">Go to Dashboard</a>
        </div>
        
        <div id="adminContent" style="display: none;">
            <div class="admin-header">
                <h1>Admin Panel</h1>
                <div class="admin-user-info">
                    <span id="adminUsername">Loading...</span>
                    <span id="adminRole" class="role-badge">Loading...</span>
                </div>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="requests" id="tabRequests">Code Requests</button>
                <button class="admin-tab" data-tab="codes" id="tabCodes">Registration Codes</button>
                <button class="admin-tab" data-tab="users" id="tabUsers">User Management</button>
                <button class="admin-tab" data-tab="game" id="tabGame">üéÆ Games</button>
                <button class="admin-tab" data-tab="stats" id="tabStats">Statistics</button>
                <button class="admin-tab" data-tab="settings" id="tabSettings">‚öôÔ∏è Settings</button>
            </div>
            
            <!-- Code Requests Section -->
            <div class="admin-section active" id="sectionRequests">
                <h2>üìù Registration Code Requests</h2>
                <div style="margin-bottom: 15px; padding: 12px; background: #e8f4f8; border-left: 4px solid #0288d1; border-radius: 6px; font-size: 13px; color: #01579b;">
                    ‚öôÔ∏è <strong>Automatic Approval:</strong> Requests are automatically approved after 3 minutes. Approved requests show (Auto) label. Server-side job runs every 2 minutes.
                </div>
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="btn-admin primary" onclick="approveAllRequests()" style="padding: 10px 20px; font-size: 14px;">‚úì Approve All Pending</button>
                </div>
                <div id="requestsMessage" class="message-box"></div>
                <table class="data-table" id="requestsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Church</th>
                            <th>Status</th>
                            <th>Requested</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTableBody">
                        <tr><td colspan="6" class="loading">Loading requests...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Registration Codes Section -->
            <div class="admin-section" id="sectionCodes">
                <h2>Registration Code Management</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role for New Code</label>
                        <select id="newCodeRole">
                            <option value="general">General Member</option>
                            <option value="treasurer">Treasurer</option>
                            <option value="organizing-secretary">Organizing Secretary</option>
                            <option value="secretary">Secretary</option>
                            <option value="vice-chair">Vice Chairperson</option>
                            <option value="chairperson">Chairperson</option>
                            <option value="moderator">Game Moderator</option>
                            <option value="admin">Administrator</option>
                            <option value="system-admin">System Administrator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="newCodeQuantity" value="1" min="1" max="10">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="multiUseCode" onchange="toggleMultiUse()">
                        <label for="multiUseCode" style="margin-bottom: 0; font-size: 13px;">Multi-use (General Members only)</label>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn-admin primary" onclick="createCodes()">Generate Codes</button>
                    </div>
                </div>
                <div id="codesMessage" class="message-box"></div>
                <table class="data-table" id="codesTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Church</th>
                            <th>Role</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="codesTableBody">
                        <tr><td colspan="6" class="loading">Loading codes...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- User Management Section -->
            <div class="admin-section" id="sectionUsers">
                <h2>User Management</h2>
                <div id="passwordResetSection" style="background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 10px; margin-bottom: 25px; display: none;">
                    <h3 style="color: #856404; margin-top: 0;">‚ö† Password Reset Requests</h3>
                    <div id="passwordResetList" style="display: grid; gap: 10px;">
                        <div style="color: #666; font-size: 14px;">No password reset requests</div>
                    </div>
                </div>
                <div id="usersMessage" class="message-box"></div>
                <table class="data-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Church</th>
                            <th>Role</th>
                            <th>Balance</th>
                            <th>Wins/Losses</th>
                            <th>Games</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="6" class="loading">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Game Management Section -->
            <div class="admin-section" id="sectionGame">
                <h2>üéÆ Game Content Management</h2>
                <div style="display: flex; gap: 8px; margin: 20px 0; flex-wrap: wrap;">
                    <button class="btn-admin primary active" id="gameTabTrivia" onclick="switchGameTab('trivia')" style="padding: 8px 16px;">Bible Trivia</button>
                    <button class="btn-admin" id="gameTabCharacter" onclick="switchGameTab('character')" style="padding: 8px 16px;">üë§ Character Guess</button>
                    <button class="btn-admin" id="gameTabFillIn" onclick="switchGameTab('fillin')" style="padding: 8px 16px;">üìù Fill-in-Blank</button>
                    <button class="btn-admin" id="gameTabScramble" onclick="switchGameTab('wordscramble')" style="padding: 8px 16px;">üî§ Word Scramble</button>
                    <button class="btn-admin" id="gameTabMemory" onclick="switchGameTab('memory')" style="padding: 8px 16px;">üß† Memory Verses</button>
                    <button class="btn-admin" id="gameTabPuzzle" onclick="switchGameTab('puzzle')" style="padding: 8px 16px;">üß© Puzzles</button>
                    <button class="btn-admin" id="gameTabWordSearch" onclick="switchGameTab('wordsearch')" style="padding: 8px 16px;">üîç Word Search</button>
                </div>
                
                <!-- Bible Trivia Tab -->
                <div id="triviaTab" style="display: block;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                        <h3 style="margin: 0;">Add New Trivia Question</h3>
                        <button class="btn-admin warning" onclick="autoPopulateTriviaCategory()" style="padding: 8px 12px; font-size: 12px;">‚ö° Auto-Populate Category</button>
                        <button class="btn-admin warning" onclick="autoPopulateAllTrivia()" style="padding: 8px 12px; font-size: 12px;">‚ö° Auto-Populate All</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Category</label>
                            <select id="newQuestionCategory">
                                <option value="oldTestament">Old Testament</option>
                                <option value="newTestament">New Testament</option>
                                <option value="jesus">Jesus & Gospels</option>
                                <option value="apostles">Apostles & Early Church</option>
                                <option value="kings">Kings & Rulers</option>
                                <option value="prophets">Prophets</option>
                                <option value="parables">Parables</option>
                                <option value="miracles">Miracles</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Question</label>
                        <input type="text" id="newQuestionText" placeholder="Enter the question">
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Option 1</label>
                            <input type="text" id="option1" placeholder="Option 1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Option 2</label>
                            <input type="text" id="option2" placeholder="Option 2">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Option 3</label>
                            <input type="text" id="option3" placeholder="Option 3">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Option 4</label>
                            <input type="text" id="option4" placeholder="Option 4">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Correct Answer</label>
                            <select id="correctAnswer">
                                <option value="0">Option 1</option>
                                <option value="1">Option 2</option>
                                <option value="2">Option 3</option>
                                <option value="3">Option 4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Hint (optional)</label>
                            <input type="text" id="hintText" placeholder="Hint for this question">
                        </div>
                    </div>
                    <button class="btn-admin success" onclick="addQuestion()">Add Question</button>
                    <div id="gameMessage" class="message-box"></div>
                    <h3 style="margin-top: 30px;">Existing Questions</h3>
                    <div class="form-group">
                        <label>View Category</label>
                        <select id="viewCategory" onchange="loadQuestions()">
                            <option value="oldTestament">Old Testament</option>
                            <option value="newTestament">New Testament</option>
                            <option value="jesus">Jesus & Gospels</option>
                            <option value="apostles">Apostles & Early Church</option>
                            <option value="kings">Kings & Rulers</option>
                            <option value="prophets">Prophets</option>
                            <option value="parables">Parables</option>
                            <option value="miracles">Miracles</option>
                        </select>
                    </div>
                    <div id="questionsList"></div>
                </div>
                
                <!-- Character Tab -->
                <div id="characterTab" style="display: none;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Add Character Guess Content</h3>
                        <button class="btn-admin warning" onclick="autoPopulateGame('character')" style="padding: 8px 12px; font-size: 12px;">‚ö° Auto-Populate from Bible</button>
                    </div>
                    <div class="form-group">
                        <label>Character Name</label>
                        <input type="text" id="charName" placeholder="e.g., Moses">
                    </div>
                    <div class="form-group">
                        <label>Clues (comma separated)</label>
                        <input type="text" id="charClues" placeholder="e.g., Led Israel out of Egypt, Received the Ten Commandments">
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="charDifficulty"><option value="easy">Easy</option><option value="medium">Medium</option><option value="hard">Hard</option></select>
                    </div>
                    <button class="btn-admin success" onclick="addGameContent('character')">Add Character</button>
                    <div id="characterMessage" class="message-box"></div>
                    <div id="characterList" style="margin-top: 30px;"></div>
                </div>
                
                <!-- Fill-in Tab -->
                <div id="fillinTab" style="display: none;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Add Fill-in-the-Blank Content</h3>
                        <button class="btn-admin warning" onclick="autoPopulateGame('fillin')" style="padding: 8px 12px; font-size: 12px;">‚ö° Auto-Populate from Bible</button>
                    </div>
                    <div class="form-group">
                        <label>Verse with blank (use ___)</label>
                        <input type="text" id="fillVerse" placeholder="e.g., In the beginning was the ___">
                    </div>
                    <div class="form-group">
                        <label>Answer</label>
                        <input type="text" id="fillAnswer" placeholder="e.g., Word">
                    </div>
                    <div class="form-group">
                        <label>Bible Reference</label>
                        <input type="text" id="fillRef" placeholder="e.g., John 1:1">
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="fillDifficulty"><option value="easy">Easy</option><option value="medium">Medium</option><option value="hard">Hard</option></select>
                    </div>
                    <button class="btn-admin success" onclick="addGameContent('fillin')">Add Verse</button>
                    <div id="fillinMessage" class="message-box"></div>
                    <div id="fillinList" style="margin-top: 30px;"></div>
                </div>
                
                <!-- Word Scramble Tab -->
                <div id="wordscrambleTab" style="display: none;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Add Word Scramble Content</h3>
                        <button class="btn-admin warning" onclick="autoPopulateGame('wordscramble')" style="padding: 8px 12px; font-size: 12px;">‚ö° Auto-Populate from Bible</button>
                    </div>
                    <div class="form-group">
                        <label>Scrambled Word</label>
                        <input type="text" id="scramWord" placeholder="e.g., SSUEJ">
                    </div>
                    <div class="form-group">
                        <label>Answer</label>
                        <input type="text" id="scramAnswer" placeholder="e.g., JESUS">
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="scramDifficulty"><option value="easy">Easy</option><option value="medium">Medium</option><option value="hard">Hard</option></select>
                    </div>
                    <button class="btn-admin success" onclick="addGameContent('wordscramble')">Add Word</button>
                    <div id="wordscrambleMessage" class="message-box"></div>
                    <div id="wordscrambleList" style="margin-top: 30px;"></div>
                </div>
                
                <!-- Memory Verses Tab -->
                <div id="memoryTab" style="display: none;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Add Memory Verse Content</h3>
                        <button class="btn-admin warning" onclick="autoPopulateGame('memory')" style="padding: 8px 12px; font-size: 12px;">‚ö° Auto-Populate from Bible</button>
                    </div>
                    <div class="form-group">
                        <label>Verse Text</label>
                        <textarea id="memVerse" placeholder="Enter the full verse" style="height: 80px;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Bible Reference</label>
                        <input type="text" id="memRef" placeholder="e.g., John 3:16">
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="memDifficulty"><option value="easy">Easy</option><option value="medium">Medium</option><option value="hard">Hard</option></select>
                    </div>
                    <button class="btn-admin success" onclick="addGameContent('memory')">Add Memory Verse</button>
                    <div id="memoryMessage" class="message-box"></div>
                    <div id="memoryList" style="margin-top: 30px;"></div>
                </div>
                
                <!-- Puzzle Tab -->
                <div id="puzzleTab" style="display: none;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Add Puzzle Content</h3>
                        <button class="btn-admin warning" onclick="autoPopulateGame('puzzle')" style="padding: 8px 12px; font-size: 12px;">‚ö° Auto-Populate from Bible</button>
                    </div>
                    <div class="form-group">
                        <label>Clue</label>
                        <input type="text" id="puzzClue" placeholder="e.g., Turned water into wine at wedding">
                    </div>
                    <div class="form-group">
                        <label>Answer</label>
                        <input type="text" id="puzzAnswer" placeholder="e.g., CANA">
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="puzzDifficulty"><option value="easy">Easy</option><option value="medium">Medium</option><option value="hard">Hard</option></select>
                    </div>
                    <button class="btn-admin success" onclick="addGameContent('puzzle')">Add Puzzle</button>
                    <div id="puzzleMessage" class="message-box"></div>
                    <div id="puzzleList" style="margin-top: 30px;"></div>
                </div>
                
                <!-- Word Search Tab -->
                <div id="wordsearchTab" style="display: none;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Add Word Search Content</h3>
                        <button class="btn-admin warning" onclick="autoPopulateGame('wordsearch')" style="padding: 8px 12px; font-size: 12px;">‚ö° Auto-Populate from Bible</button>
                    </div>
                    <div class="form-group">
                        <label>Words to hide (comma separated)</label>
                        <input type="text" id="wsWords" placeholder="e.g., JESUS, LOVE, FAITH, HOPE">
                    </div>
                    <div class="form-group">
                        <label>Grid Size</label>
                        <input type="number" id="wsGridSize" placeholder="e.g., 10" min="8" max="15">
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="wsDifficulty"><option value="easy">Easy</option><option value="medium">Medium</option><option value="hard">Hard</option></select>
                    </div>
                    <button class="btn-admin success" onclick="addGameContent('wordsearch')">Add Word Search</button>
                    <div id="wordsearchMessage" class="message-box"></div>
                    <div id="wordsearchList" style="margin-top: 30px;"></div>
                </div>
            </div>
            
            <!-- Statistics Section -->
            <div class="admin-section" id="sectionStats">
                <h2>System Statistics</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalGames">0</h3>
                        <p>Total Games Played</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="activeCodes">0</h3>
                        <p>Active Codes</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="usedCodes">0</h3>
                        <p>Used Codes</p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Section -->
            <div class="admin-section" id="sectionSettings">
                <h2>Login Page Settings</h2>
                <div class="form-group">
                    <label>Login Page Background Image</label>
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Upload an image to display behind the AIC logo and verse section on the login page.</p>
                    <input type="file" id="bgImageInput" accept="image/*" style="padding: 10px; border: 2px dashed #667eea; border-radius: 8px; width: 100%; cursor: pointer;">
                </div>
                <button class="btn-admin primary" onclick="uploadLoginBackground()" style="margin-top: 10px;">Upload Background Image</button>
                <div id="settingsMessage" class="message-box"></div>
                <div id="previewContainer" style="margin-top: 20px; display: none;">
                    <p style="font-weight: 600; margin-bottom: 10px;">Current Background:</p>
                    <img id="previewImage" style="max-width: 100%; max-height: 300px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);">
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = null;
        let currentUsername = null;
        let userRole = null;
        
        const roleNames = {
            'system-admin': 'System Administrator',
            'admin': 'Administrator',
            'moderator': 'Game Moderator',
            'chairperson': 'Chairperson',
            'vice-chair': 'Vice Chairperson',
            'secretary': 'Secretary',
            'organizing-secretary': 'Organizing Secretary',
            'treasurer': 'Treasurer',
            'general': 'General Member'
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
        
        async function checkAuth() {
            authToken = localStorage.getItem('authToken');
            currentUsername = localStorage.getItem('username');
            userRole = localStorage.getItem('userRole');
            
            if (!authToken || !currentUsername) {
                window.location.href = 'login.html';
                return;
            }
            
            // Check if user has admin access
            const adminRoles = ['system-admin', 'admin', 'moderator'];
            if (!adminRoles.includes(userRole)) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('noAccessState').style.display = 'block';
                return;
            }
            
            // Setup UI
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            document.getElementById('adminUsername').textContent = currentUsername;
            document.getElementById('adminRole').textContent = roleNames[userRole] || userRole;
            document.getElementById('userDisplay').textContent = `${currentUsername}`;
            document.getElementById('userDisplayMobile').textContent = `${currentUsername}`;
            document.getElementById('navMiddle').style.display = 'flex';
            document.getElementById('mobileMenuBtn').style.display = 'flex';
            
            // Setup tabs based on role
            setupTabs();
            
            // Load initial data
            loadCodeRequests();
            loadCodes();
            loadUsers();
            loadStats();
        }
        
        function setupTabs() {
            const tabs = document.querySelectorAll('.admin-tab');
            
            // Disable tabs based on role
            if (userRole === 'admin') {
                document.getElementById('tabCodes').disabled = true;
                document.getElementById('tabGame').disabled = true;
                switchTab('users');
            } else if (userRole === 'moderator') {
                document.getElementById('tabCodes').disabled = true;
                document.getElementById('tabUsers').disabled = true;
                switchTab('game');
            }
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    if (!tab.disabled) {
                        switchTab(tab.dataset.tab);
                    }
                });
            });
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`section${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');
            
            if (tabId === 'requests') {
                loadCodeRequests();
            } else if (tabId === 'codes') {
                loadCodes();
            } else if (tabId === 'game') {
                loadQuestions();
            }
        }
        
        async function loadCodeRequests() {
            try {
                const response = await fetch('/api/admin/code-requests', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load code requests');
                }
                
                const data = await response.json();
                renderCodeRequests(data.requests);
            } catch (error) {
                console.error('Error loading code requests:', error);
                document.getElementById('requestsTableBody').innerHTML = '<tr><td colspan="6">Error loading requests</td></tr>';
            }
        }
        
        function formatSafeDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return 'Invalid Date';
                return d.toLocaleDateString();
            } catch (e) {
                return 'Invalid Date';
            }
        }
        
        function renderCodeRequests(requests) {
            const tbody = document.getElementById('requestsTableBody');
            
            if (!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No code requests</td></tr>';
                return;
            }
            
            const pendingRequests = requests.filter(r => r.status === 'pending');
            const approvedRequests = requests.filter(r => r.status === 'approved');
            
            let html = '';
            
            if (pendingRequests.length > 0) {
                html += '<tr style="background: #fff3cd;"><td colspan="5" style="font-weight: bold; padding: 10px;">Pending Requests</td></tr>';
                html += pendingRequests.map(req => `
                    <tr>
                        <td>${req.name}</td>
                        <td>${req.phone}</td>
                        <td style="max-width: 200px; word-break: break-word;">${req.church || 'N/A'}</td>
                        <td><span class="status-badge available">${req.status || 'Pending'}</span></td>
                        <td>${formatSafeDate(req.createdAt)}</td>
                        <td>
                            <div class="action-buttons" style="display: flex; gap: 5px;">
                                <button class="btn-admin success" onclick="openApproveModal('${req.id}', '${req.name}')" style="padding: 6px 12px; font-size: 12px;">Approve & Send Code</button>
                                <button class="btn-admin danger" onclick="rejectCodeRequest('${req.id}')" style="padding: 6px 12px; font-size: 12px;">Reject</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            if (approvedRequests.length > 0) {
                html += '<tr style="background: #d4edda;"><td colspan="6" style="font-weight: bold; padding: 10px;">‚úì Approved Requests (Codes Generated)</td></tr>';
                html += approvedRequests.map(req => `
                    <tr style="opacity: ${req.auto ? '0.85' : '1'}; background: #f0f8ff;">
                        <td>${req.name}</td>
                        <td>${req.phone}</td>
                        <td style="max-width: 150px; word-break: break-word;">${req.church || 'N/A'}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <code style="
                                    background: white;
                                    border: 2px solid #0066cc;
                                    color: #0066cc;
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    font-weight: bold;
                                    font-size: 12px;
                                    letter-spacing: 1px;
                                    min-width: 80px;
                                    text-align: center;
                                ">${req.generatedCode}</code>
                                <button 
                                    onclick="copyCodeToClipboard('${req.generatedCode}', this)" 
                                    style="
                                        padding: 4px 8px;
                                        background: #0066cc;
                                        color: white;
                                        border: none;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-size: 11px;
                                        font-weight: 600;
                                        min-height: 28px;
                                        transition: all 0.3s;
                                    "
                                    onmouseover="this.style.background='#0052a3'"
                                    onmouseout="this.style.background='#0066cc'"
                                >Copy</button>
                                <span style="font-size: 11px; color: #666; background: #e8f4f8; padding: 2px 6px; border-radius: 3px; white-space: nowrap;">${req.auto ? 'ü§ñ Auto' : 'üë§ Manual'}</span>
                            </div>
                        </td>
                        <td style="font-size: 12px; color: #666;">${formatSafeDate(req.approvedAt)}</td>
                        <td>
                            <button class="btn-admin danger" onclick="rejectCodeRequest('${req.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            tbody.innerHTML = html;
        }
        
        function openApproveModal(requestId, requesterName) {
            const roleSelect = document.createElement('select');
            roleSelect.id = 'approvalRole';
            roleSelect.innerHTML = `
                <option value="general">General Member</option>
                <option value="treasurer">Treasurer</option>
                <option value="organizing-secretary">Organizing Secretary</option>
                <option value="secretary">Secretary</option>
                <option value="vice-chair">Vice Chairperson</option>
                <option value="chairperson">Chairperson</option>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'approveModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <h2 style="margin: 0 0 20px; color: #1a365d;">Approve Code Request</h2>
                    <p style="color: #666; margin: 0 0 15px;">Approve request from <strong>${requesterName}</strong></p>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b;">Role:</label>
                    <select id="approvalRole" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                        <option value="general">General Member</option>
                        <option value="treasurer">Treasurer</option>
                        <option value="organizing-secretary">Organizing Secretary</option>
                        <option value="secretary">Secretary</option>
                        <option value="vice-chair">Vice Chairperson</option>
                        <option value="chairperson">Chairperson</option>
                    </select>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="confirmApprove('${requestId}')" class="btn-admin success" style="flex: 1;">Generate Code</button>
                        <button onclick="document.getElementById('approveModal').remove()" class="btn-admin" style="flex: 1; background: #ccc;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function confirmApprove(requestId) {
            const role = document.getElementById('approvalRole').value;
            
            try {
                const response = await fetch(`/api/admin/code-requests/${requestId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ role })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to approve request');
                }
                
                showMessage('requestsMessage', `‚úì Code Generated: ${data.code}`, 'success');
                document.getElementById('approveModal').remove();
                loadCodeRequests();
            } catch (error) {
                showMessage('requestsMessage', error.message, 'error');
            }
        }
        
        async function rejectCodeRequest(requestId) {
            if (!confirm('Delete this request?')) return;
            
            try {
                const response = await fetch(`/api/admin/code-requests/${requestId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete request');
                }
                
                showMessage('requestsMessage', 'Request deleted', 'success');
                loadCodeRequests();
            } catch (error) {
                showMessage('requestsMessage', error.message, 'error');
            }
        }
        
        async function approveAllRequests() {
            if (!confirm('Approve all pending requests?')) return;
            
            try {
                const response = await fetch('/api/admin/code-requests/approve-all/pending', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to approve all requests');
                }
                
                showMessage('requestsMessage', `‚úì Successfully approved ${data.count} requests`, 'success');
                loadCodeRequests();
            } catch (error) {
                showMessage('requestsMessage', error.message, 'error');
            }
        }
        
        function copyCodeToClipboard(code, button) {
            if (!code) {
                showAdminAlert('No code to copy', 'error');
                return;
            }
            
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.textContent;
                const originalBg = button.style.background;
                button.textContent = '‚úì Copied!';
                button.style.background = '#28a745';
                button.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = originalBg;
                    button.style.transform = 'scale(1)';
                }, 2000);
            }).catch((err) => {
                console.error('Copy failed:', err);
                showAdminAlert('Failed to copy code. Please try again.', 'error');
            });
        }
        
        function showAdminAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 14px 18px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                z-index: 50000;
                animation: slideInRight 0.4s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 300px;
            `;
            
            if (type === 'error') {
                alertDiv.style.background = '#f8d7da';
                alertDiv.style.color = '#721c24';
                alertDiv.style.border = '2px solid #f5c6cb';
            } else if (type === 'success') {
                alertDiv.style.background = '#d4edda';
                alertDiv.style.color = '#155724';
                alertDiv.style.border = '2px solid #c3e6cb';
            } else {
                alertDiv.style.background = '#fff3cd';
                alertDiv.style.color = '#856404';
                alertDiv.style.border = '2px solid #ffeeba';
            }
            
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOutRight 0.4s ease';
                setTimeout(() => alertDiv.remove(), 400);
            }, 2500);
        }
        
        async function loadCodes() {
            try {
                const response = await fetch('/api/admin/codes', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        document.getElementById('codesTableBody').innerHTML = '<tr><td colspan="5">Access denied</td></tr>';
                        return;
                    }
                    throw new Error('Failed to load codes');
                }
                
                const data = await response.json();
                renderCodes(data.codes);
                
                // Update stats
                const activeCodes = data.codes.filter(c => !c.used).length;
                const usedCodes = data.codes.filter(c => c.used).length;
                document.getElementById('activeCodes').textContent = activeCodes;
                document.getElementById('usedCodes').textContent = usedCodes;
            } catch (error) {
                console.error('Error loading codes:', error);
            }
        }
        
        function renderCodes(codes) {
            const tbody = document.getElementById('codesTableBody');
            
            if (!codes || codes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No codes found</td></tr>';
                return;
            }
            
            tbody.innerHTML = codes.map(code => `
                <tr>
                    <td><span class="code-badge">${code.code}</span></td>
                    <td>${roleNames[code.role] || code.role}</td>
                    <td><span class="status-badge ${code.multiUse ? 'multi-use' : 'single-use'}">${code.multiUse ? 'Multi-use' : 'Single-use'}</span></td>
                    <td><span class="status-badge ${code.used ? 'used' : 'available'}">${code.multiUse ? `Used ${code.usageCount || 0} times` : (code.used ? 'Used' : 'Available')}</span></td>
                    <td>${formatSafeDate(code.createdAt)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-admin danger" onclick="deleteCode('${code.code}')" ${code.used && !code.multiUse ? 'disabled' : ''}>Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function toggleMultiUse() {
            const checkbox = document.getElementById('multiUseCode');
            const roleSelect = document.getElementById('newCodeRole');
            const quantityInput = document.getElementById('newCodeQuantity');
            
            if (checkbox.checked) {
                if (roleSelect.value !== 'general') {
                    showMessage('codesMessage', 'Multi-use codes can only be created for General Members', 'error');
                    checkbox.checked = false;
                    return;
                }
                quantityInput.max = "1";
                quantityInput.value = "1";
                quantityInput.disabled = true;
            } else {
                quantityInput.max = "10";
                quantityInput.disabled = false;
            }
        }
        
        async function createCodes() {
            const role = document.getElementById('newCodeRole').value;
            const quantity = parseInt(document.getElementById('newCodeQuantity').value);
            const multiUse = document.getElementById('multiUseCode').checked;
            
            if (multiUse && role !== 'general') {
                showMessage('codesMessage', 'Multi-use codes can only be created for General Members', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/codes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ role, quantity, multiUse })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create codes');
                }
                
                showMessage('codesMessage', `Created ${quantity} code(s) successfully! ${multiUse ? '(Multi-use)' : ''}`, 'success');
                document.getElementById('multiUseCode').checked = false;
                loadCodes();
            } catch (error) {
                showMessage('codesMessage', error.message, 'error');
            }
        }
        
        async function deleteCode(code) {
            if (!confirm(`Delete code ${code}?`)) return;
            
            try {
                const response = await fetch(`/api/admin/codes/${code}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete code');
                }
                
                showMessage('codesMessage', 'Code deleted', 'success');
                loadCodes();
            } catch (error) {
                showMessage('codesMessage', error.message, 'error');
            }
        }
        
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="6">Access denied</td></tr>';
                        return;
                    }
                    throw new Error('Failed to load users');
                }
                
                const data = await response.json();
                renderUsers(data.users);
                
                // Update stats
                document.getElementById('totalUsers').textContent = data.users.length;
                const totalGames = data.users.reduce((sum, u) => sum + (u.gamesPlayed || 0), 0);
                document.getElementById('totalGames').textContent = totalGames;
                
                // Load password resets
                loadPasswordResets();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        let resetTimerIntervals = {};

        async function loadPasswordResets() {
            try {
                const response = await fetch('/api/admin/password-resets', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                const section = document.getElementById('passwordResetSection');
                const list = document.getElementById('passwordResetList');
                
                if (!data.users || data.users.length === 0) {
                    section.style.display = 'none';
                    return;
                }
                
                section.style.display = 'block';
                list.innerHTML = data.users.map(u => `
                    <div id="reset-item-${u.username}" style="background: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; gap: 15px; border-left: 4px solid ${u.autoGenerated ? '#10b981' : '#ffc107'};">
                        <div style="flex: 1;">
                            <strong>${u.username}</strong>
                            <span class="role-badge" style="margin-left: 10px;">${roleNames[u.role] || u.role}</span>
                            <div style="font-size: 12px; color: #888; margin-top: 5px;">Requested: ${formatSafeDate(u.requestedAt)}</div>
                            <div id="timer-${u.username}" style="font-size: 13px; color: #dc2626; font-weight: 600; margin-top: 8px; padding: 8px 12px; background: #fee2e2; border-radius: 6px; display: inline-block; border: 1px solid #fca5a5;">
                                ‚è± Auto-reset in: <span id="countdown-${u.username}">${u.secondsRemaining}</span>s ${u.autoGenerated ? '‚úì Auto-Generated' : ''}
                            </div>
                        </div>
                        <button class="btn-admin warning" onclick="showPasswordResetPrompt('${u.username}')" style="white-space: nowrap;">Reset Now</button>
                    </div>
                `).join('');

                // Start countdown timers
                data.users.forEach(u => {
                    startResetCountdown(u.username, u.timeRemainingMs);
                });
            } catch (error) {
                console.error('Error loading password resets:', error);
            }
        }

        function startResetCountdown(username, timeRemainingMs) {
            // Clear existing timer if any
            if (resetTimerIntervals[username]) {
                clearInterval(resetTimerIntervals[username]);
            }

            let secondsRemaining = Math.ceil(timeRemainingMs / 1000);
            const countdownEl = document.getElementById(`countdown-${username}`);

            resetTimerIntervals[username] = setInterval(() => {
                secondsRemaining--;
                if (countdownEl) {
                    countdownEl.textContent = Math.max(0, secondsRemaining);
                }

                if (secondsRemaining <= 0) {
                    clearInterval(resetTimerIntervals[username]);
                    delete resetTimerIntervals[username];
                    // Reload to update status after auto-reset completes
                    setTimeout(() => {
                        loadPasswordResets();
                    }, 1000);
                }
            }, 1000);
        }
        
        function showPasswordResetPrompt(username) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 10002;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 35px;
                border-radius: 15px;
                max-width: 450px;
                width: 100%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            `;
            content.className = 'password-reset-modal';
            content.setAttribute('data-username', username);
            
            let timeRemaining = 5; // 5 seconds
            let timerInterval;
            
            const updateTimer = () => {
                const timerEl = content.querySelector('#resetTimer');
                if (timerEl) {
                    timerEl.textContent = `Auto-reset in: ${timeRemaining}s`;
                }
                timeRemaining--;
                if (timeRemaining < 0) {
                    clearInterval(timerInterval);
                    autoResetPassword(username, modal);
                }
            };
            
            timerInterval = setInterval(updateTimer, 1000);
            content.setAttribute('data-timer-interval', timerInterval);
            
            content.innerHTML = `
                <h2 style="margin: 0 0 20px; color: #1a365d; font-size: 18px; font-weight: 700;">Reset Password for ${username}</h2>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 14px;">Choose option:</label>
                    
                    <button class="reset-pwd-auto-btn" style="
                        width: 100%;
                        padding: 12px 15px;
                        margin-bottom: 10px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 14px;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.3)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">‚ö° Auto-Generate Password</button>
                    
                    <button class="reset-pwd-manual-btn" style="
                        width: 100%;
                        padding: 12px 15px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 14px;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.3)';" onmouseout="this.style.transform='none'; this.style.boxShadow='none';">‚úèÔ∏è Enter Custom Password</button>
                </div>
                
                <div id="resetTimer" style="
                    text-align: center;
                    color: #dc2626;
                    font-weight: 600;
                    font-size: 13px;
                    margin-bottom: 15px;
                    padding: 10px;
                    background: #fee2e2;
                    border-radius: 8px;
                    border: 1px solid #fecaca;
                ">Auto-reset in: 5s</div>
                
                <button class="reset-pwd-cancel-btn" style="
                    width: 100%;
                    padding: 10px;
                    background: #e5e7eb;
                    border: 1px solid #d1d5db;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    color: #374151;
                    font-size: 14px;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#d1d5db';" onmouseout="this.style.background='#e5e7eb';">Cancel</button>
            `;
            
            // Add event listeners
            const autoBtn = content.querySelector('.reset-pwd-auto-btn');
            const manualBtn = content.querySelector('.reset-pwd-manual-btn');
            const cancelBtn = content.querySelector('.reset-pwd-cancel-btn');
            
            autoBtn.addEventListener('click', () => {
                clearInterval(timerInterval);
                autoResetPassword(username, modal);
            });
            
            manualBtn.addEventListener('click', () => {
                clearInterval(timerInterval);
                manualResetPassword(username, modal);
            });
            
            cancelBtn.addEventListener('click', () => {
                clearInterval(timerInterval);
                modal.style.display = 'none';
            });
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        async function autoResetPassword(username, modal) {
            try {
                const response = await fetch(`/api/admin/users/${username}/auto-reset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to reset password');
                }
                
                if (modal && modal.parentNode) modal.remove();
                showMessage('usersMessage', `‚úì Password auto-generated for ${username}. Will auto-reset in 5 seconds.`, 'success');
                
                // Auto-reset after 5 seconds
                setTimeout(() => {
                    autoResetPassword(username, null);
                }, 5 * 1000);
                
                loadUsers();
            } catch (error) {
                showMessage('usersMessage', error.message, 'error');
            }
        }
        
        function manualResetPassword(username, modal) {
            const newPassword = prompt(`Enter new password for ${username}:\n(minimum 6 characters)`);
            if (newPassword && newPassword.length >= 6) {
                resetPassword(username, newPassword);
                if (modal && modal.parentNode) modal.remove();
            } else if (newPassword) {
                alert('Password must be at least 6 characters');
            }
        }
        
        async function resetPassword(username, newPassword) {
            try {
                const response = await fetch(`/api/admin/users/${username}/password-reset`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ newPassword })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to reset password');
                }
                
                showMessage('usersMessage', `‚úì Password reset for ${username}`, 'success');
                loadUsers();
            } catch (error) {
                showMessage('usersMessage', error.message, 'error');
            }
        }
        
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.church || 'N/A'}</td>
                    <td><span class="role-badge">${roleNames[user.role] || user.role}</span></td>
                    <td>$${(user.balance || 0).toFixed(2)}</td>
                    <td>${user.wins || 0} / ${user.losses || 0}</td>
                    <td>${user.gamesPlayed || 0}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-admin warning" onclick="adjustBalance('${user.username}', 'add')">+Balance</button>
                            <button class="btn-admin warning" onclick="adjustBalance('${user.username}', 'deduct')">-Balance</button>
                            <button class="btn-admin primary" onclick="resetStats('${user.username}')">Reset</button>
                            ${userRole === 'system-admin' ? `<button class="btn-admin danger" onclick="deleteUser('${user.username}')">Delete</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        async function adjustBalance(username, operation) {
            const amount = prompt(`Enter amount to ${operation}:`);
            if (!amount || isNaN(parseFloat(amount))) return;
            
            try {
                const response = await fetch(`/api/admin/users/${username}/balance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ amount: parseFloat(amount), operation })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update balance');
                }
                
                showMessage('usersMessage', `Balance updated for ${username}. New balance: $${data.newBalance.toFixed(2)}`, 'success');
                loadUsers();
            } catch (error) {
                showMessage('usersMessage', error.message, 'error');
            }
        }
        
        async function resetStats(username) {
            if (!confirm(`Reset all stats for ${username}?`)) return;
            
            try {
                const response = await fetch(`/api/admin/users/${username}/reset`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to reset stats');
                }
                
                showMessage('usersMessage', `Stats reset for ${username}`, 'success');
                loadUsers();
            } catch (error) {
                showMessage('usersMessage', error.message, 'error');
            }
        }
        
        async function deleteUser(username) {
            if (!confirm(`DELETE user ${username}? This cannot be undone!`)) return;
            
            try {
                const response = await fetch(`/api/admin/users/${username}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to delete user');
                }
                
                showMessage('usersMessage', `User ${username} deleted`, 'success');
                loadUsers();
            } catch (error) {
                showMessage('usersMessage', error.message, 'error');
            }
        }
        
        async function loadQuestions() {
            const category = document.getElementById('viewCategory').value;
            
            try {
                const response = await fetch('/api/admin/questions', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    document.getElementById('questionsList').innerHTML = '<p>Access denied or error loading questions</p>';
                    return;
                }
                
                const data = await response.json();
                const questions = data.questions[category] || [];
                
                renderQuestions(questions, category);
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }
        
        function renderQuestions(questions, category) {
            const container = document.getElementById('questionsList');
            
            if (!questions || questions.length === 0) {
                container.innerHTML = '<p>No questions in this category</p>';
                return;
            }
            
            container.innerHTML = questions.map((q, i) => `
                <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea;">
                    <strong>Q${i + 1}:</strong> ${q.question}<br>
                    <small style="color: #666;">Answer: ${q.options[q.correctIndex]}</small>
                    <button class="btn-admin danger" style="float: right; padding: 4px 8px; font-size: 11px;" onclick="deleteQuestion('${category}', '${q.questionId}')">Delete</button>
                </div>
            `).join('');
        }
        
        async function addQuestion() {
            const category = document.getElementById('newQuestionCategory').value;
            const question = document.getElementById('newQuestionText').value.trim();
            const options = [
                document.getElementById('option1').value.trim(),
                document.getElementById('option2').value.trim(),
                document.getElementById('option3').value.trim(),
                document.getElementById('option4').value.trim()
            ];
            const correctIndex = parseInt(document.getElementById('correctAnswer').value);
            const hintText = document.getElementById('hintText').value.trim();
            
            if (!question || options.some(o => !o)) {
                showMessage('gameMessage', 'Please fill in the question and all options', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        category,
                        question,
                        options,
                        correctIndex,
                        hints: hintText ? [{ text: hintText, cost: 10 }] : []
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to add question');
                }
                
                showMessage('gameMessage', 'Question added successfully!', 'success');
                
                // Clear form
                document.getElementById('newQuestionText').value = '';
                document.getElementById('option1').value = '';
                document.getElementById('option2').value = '';
                document.getElementById('option3').value = '';
                document.getElementById('option4').value = '';
                document.getElementById('hintText').value = '';
                
                loadQuestions();
            } catch (error) {
                showMessage('gameMessage', error.message, 'error');
            }
        }
        
        async function deleteQuestion(category, questionId) {
            if (!confirm('Delete this question?')) return;
            
            try {
                const response = await fetch(`/api/admin/questions/${category}/${questionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete question');
                }
                
                showMessage('gameMessage', 'Question deleted', 'success');
                loadQuestions();
            } catch (error) {
                showMessage('gameMessage', error.message, 'error');
            }
        }
        
        function switchGameTab(tabName) {
            // Hide all tabs
            ['trivia', 'character', 'fillin', 'wordscramble', 'memory', 'puzzle', 'wordsearch'].forEach(tab => {
                document.getElementById(tab + 'Tab').style.display = 'none';
                document.getElementById('gameTab' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';
            document.getElementById('gameTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1))?.classList.add('active');
            
            // Load content for the selected game
            if (tabName !== 'trivia') {
                loadGameContent(tabName);
            } else {
                loadQuestions();
            }
        }
        
        async function loadGameContent(gameType) {
            try {
                const response = await fetch(`/api/admin/games/${gameType}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    console.error('Failed to load game content');
                    return;
                }
                
                const data = await response.json();
                renderGameContent(gameType, data.content);
            } catch (error) {
                console.error('Error loading game content:', error);
            }
        }
        
        function renderGameContent(gameType, content) {
            const container = document.getElementById(gameType + 'List');
            if (!container) return;
            
            if (!content || content.length === 0) {
                container.innerHTML = '<p>No content added yet</p>';
                return;
            }
            
            let html = '<div style="margin-top: 20px;">';
            content.forEach((item, i) => {
                html += `<div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea;">`;
                html += `<strong>#${i + 1}</strong> `;
                
                if (gameType === 'character') {
                    html += `${item.name} (${item.difficulty}) - ${item.clues?.join(', ')}`;
                } else if (gameType === 'fillin') {
                    html += `${item.verse} ‚Üí ${item.answer} (${item.reference})`;
                } else if (gameType === 'wordscramble') {
                    html += `${item.scrambled} ‚Üí ${item.answer}`;
                } else if (gameType === 'memory') {
                    html += `${item.verse.substring(0, 50)}... (${item.reference})`;
                } else if (gameType === 'puzzle') {
                    html += `${item.clue} ‚Üí ${item.answer}`;
                } else if (gameType === 'wordsearch') {
                    html += `Words: ${item.words?.join(', ')} (Grid: ${item.gridSize}x${item.gridSize})`;
                }
                
                html += `<button class="btn-admin danger" style="float: right; padding: 4px 8px; font-size: 11px;" onclick="deleteGameContent('${gameType}', '${item.id}')">Delete</button></div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function addGameContent(gameType) {
            let newItem = { difficulty: 'easy' };
            let messageId = gameType + 'Message';
            
            if (gameType === 'character') {
                newItem.name = document.getElementById('charName').value.trim();
                newItem.clues = document.getElementById('charClues').value.split(',').map(c => c.trim());
                newItem.difficulty = document.getElementById('charDifficulty').value;
                if (!newItem.name) { showMessage(messageId, 'Name required', 'error'); return; }
            } else if (gameType === 'fillin') {
                newItem.verse = document.getElementById('fillVerse').value.trim();
                newItem.answer = document.getElementById('fillAnswer').value.trim();
                newItem.reference = document.getElementById('fillRef').value.trim();
                newItem.difficulty = document.getElementById('fillDifficulty').value;
                if (!newItem.verse || !newItem.answer) { showMessage(messageId, 'All fields required', 'error'); return; }
            } else if (gameType === 'wordscramble') {
                newItem.scrambled = document.getElementById('scramWord').value.trim().toUpperCase();
                newItem.answer = document.getElementById('scramAnswer').value.trim().toUpperCase();
                newItem.difficulty = document.getElementById('scramDifficulty').value;
                if (!newItem.scrambled || !newItem.answer) { showMessage(messageId, 'All fields required', 'error'); return; }
            } else if (gameType === 'memory') {
                newItem.verse = document.getElementById('memVerse').value.trim();
                newItem.reference = document.getElementById('memRef').value.trim();
                newItem.difficulty = document.getElementById('memDifficulty').value;
                if (!newItem.verse || !newItem.reference) { showMessage(messageId, 'All fields required', 'error'); return; }
            } else if (gameType === 'puzzle') {
                newItem.clue = document.getElementById('puzzClue').value.trim();
                newItem.answer = document.getElementById('puzzAnswer').value.trim().toUpperCase();
                newItem.difficulty = document.getElementById('puzzDifficulty').value;
                if (!newItem.clue || !newItem.answer) { showMessage(messageId, 'All fields required', 'error'); return; }
            } else if (gameType === 'wordsearch') {
                newItem.words = document.getElementById('wsWords').value.split(',').map(w => w.trim().toUpperCase());
                newItem.gridSize = parseInt(document.getElementById('wsGridSize').value) || 10;
                newItem.difficulty = document.getElementById('wsDifficulty').value;
                if (newItem.words.length === 0) { showMessage(messageId, 'Words required', 'error'); return; }
            }
            
            try {
                const response = await fetch(`/api/admin/games/${gameType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(newItem)
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to add content');
                
                showMessage(messageId, 'Content added successfully!', 'success');
                loadGameContent(gameType);
                
                // Clear form fields
                document.querySelectorAll(`input[id^="${gameType.substring(0, 4)}"], textarea[id^="${gameType.substring(0, 4)}"]`).forEach(el => el.value = '');
            } catch (error) {
                showMessage(messageId, error.message, 'error');
            }
        }
        
        async function deleteGameContent(gameType, itemId) {
            if (!confirm('Delete this content?')) return;
            
            try {
                const response = await fetch(`/api/admin/games/${gameType}/${itemId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to delete');
                
                showMessage(gameType + 'Message', 'Content deleted', 'success');
                loadGameContent(gameType);
            } catch (error) {
                showMessage(gameType + 'Message', error.message, 'error');
            }
        }
        
        async function autoPopulateGame(gameType) {
            if (!confirm(`Auto-populate ${gameType} with Bible content? This will replace existing content.`)) return;
            
            try {
                const response = await fetch(`/api/admin/games/${gameType}/auto-populate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to auto-populate');
                
                showMessage(gameType + 'Message', `‚úì ${data.message}`, 'success');
                loadGameContent(gameType);
            } catch (error) {
                showMessage(gameType + 'Message', error.message, 'error');
            }
        }
        
        async function autoPopulateTriviaCategory() {
            const category = document.getElementById('newQuestionCategory').value;
            if (!confirm(`Auto-populate "${category}" with Bible trivia questions? This will replace existing questions in this category.`)) return;
            
            try {
                const response = await fetch(`/api/admin/questions/auto-populate/${category}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to auto-populate');
                
                showMessage('gameMessage', `‚úì ${data.message}`, 'success');
                loadQuestions();
            } catch (error) {
                showMessage('gameMessage', error.message, 'error');
            }
        }
        
        async function autoPopulateAllTrivia() {
            if (!confirm('Auto-populate ALL trivia categories with Bible questions? This will replace all existing questions.')) return;
            
            try {
                const response = await fetch('/api/admin/questions/auto-populate-all', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to auto-populate');
                
                showMessage('gameMessage', `‚úì ${data.message}`, 'success');
                loadQuestions();
            } catch (error) {
                showMessage('gameMessage', error.message, 'error');
            }
        }
        
        function loadStats() {
            // Stats are loaded along with users and codes
        }
        
        function showMessage(elementId, message, type = 'success') {
            const el = document.getElementById(elementId);
            
            // Clear any existing timeout
            if (el.dismissTimeout) {
                clearTimeout(el.dismissTimeout);
            }
            
            // Define icon and title for each type
            const messageConfig = {
                success: { icon: '‚úì', title: 'Success' },
                error: { icon: '‚úï', title: 'Error' },
                warning: { icon: '‚ö†', title: 'Warning' },
                info: { icon: '‚Ñπ', title: 'Info' }
            };
            
            const config = messageConfig[type] || messageConfig.success;
            
            // Build message HTML
            el.innerHTML = `
                <div class="msg-icon">${config.icon}</div>
                <div class="msg-content">
                    <div class="msg-title">${config.title}</div>
                    <div class="msg-text">${message}</div>
                </div>
                <button class="msg-close" onclick="closeMessage('${elementId}')">√ó</button>
            `;
            
            el.className = `message-box ${type}`;
            
            // Auto-dismiss after 5 seconds
            el.dismissTimeout = setTimeout(() => {
                closeMessage(elementId);
            }, 5000);
        }
        
        function closeMessage(elementId) {
            const el = document.getElementById(elementId);
            if (el.dismissTimeout) {
                clearTimeout(el.dismissTimeout);
            }
            el.classList.add('hide');
            setTimeout(() => {
                el.className = 'message-box';
                el.innerHTML = '';
                el.classList.remove('hide');
            }, 300);
        }
        
        function toggleMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            mobileNav.classList.toggle('active');
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            localStorage.removeItem('userRole');
            window.location.href = 'landing.html';
        }
        
        async function uploadLoginBackground() {
            const fileInput = document.getElementById('bgImageInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('settingsMessage', 'Please select an image file', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/admin/upload-login-bg', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Upload failed');
                }
                
                showMessage('settingsMessage', '‚úì Login background updated successfully!', 'success');
                fileInput.value = '';
                loadLoginPreview();
            } catch (error) {
                showMessage('settingsMessage', error.message, 'error');
            }
        }
        
        async function loadLoginPreview() {
            try {
                const response = await fetch('/api/login-bg');
                const data = await response.json();
                
                if (data.imagePath) {
                    const container = document.getElementById('previewContainer');
                    const img = document.getElementById('previewImage');
                    img.src = data.imagePath;
                    container.style.display = 'block';
                }
            } catch (error) {
                console.log('Could not load preview');
            }
        }
        
        // Load preview when settings tab is opened
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (this.dataset.tab === 'settings') {
                        loadLoginPreview();
                    }
                });
            });
        });
    </script>
    <script src="js/session.js"></script>
</body>
</html>
